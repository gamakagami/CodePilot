version: '3.8'

services:
  # PostgreSQL for Auth Service
  auth-postgres:
    image: postgres:15-alpine
    container_name: auth-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${AUTH_POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${AUTH_POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${AUTH_POSTGRES_DB:-auth_db}
    ports:
      - "${AUTH_POSTGRES_PORT:-5432}:5432"
    volumes:
      - auth_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${AUTH_POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - codepilot-network

  # PostgreSQL for User Service
  user-postgres:
    image: postgres:15-alpine
    container_name: user-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${USER_POSTGRES_USER:-userservice}
      POSTGRES_PASSWORD: ${USER_POSTGRES_PASSWORD:-userservice_password}
      POSTGRES_DB: ${USER_POSTGRES_DB:-userservice_db}
    ports:
      - "${USER_POSTGRES_PORT:-5433}:5432"
    volumes:
      - user_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${USER_POSTGRES_USER:-userservice}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - codepilot-network

  # PostgreSQL for Failure Prediction Service
  prediction-postgres:
    image: postgres:15-alpine
    container_name: prediction-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${PREDICTION_POSTGRES_USER:-predictionservice}
      POSTGRES_PASSWORD: ${PREDICTION_POSTGRES_PASSWORD:-prediction_password}
      POSTGRES_DB: ${PREDICTION_POSTGRES_DB:-prediction_db}
    ports:
      - "${PREDICTION_POSTGRES_PORT:-5434}:5432"
    volumes:
      - prediction_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PREDICTION_POSTGRES_USER:-predictionservice}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - codepilot-network

  # Neo4j for Code Analysis Service
  neo4j:
    image: neo4j:5.12-community
    container_name: analysis-neo4j
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-neo4j_password}
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: apoc.*
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474"
      - "${NEO4J_BOLT_PORT:-7687}:7687"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "${NEO4J_USER:-neo4j}", "-p", "${NEO4J_PASSWORD:-neo4j_password}", "RETURN 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - codepilot-network

  # Auth Service
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    restart: unless-stopped
    ports:
      - "${AUTH_SERVICE_PORT:-4001}:4001"
    environment:
      PORT: 4001
      DATABASE_URL: postgresql://${AUTH_POSTGRES_USER:-postgres}:${AUTH_POSTGRES_PASSWORD:-postgres}@auth-postgres:5432/${AUTH_POSTGRES_DB:-auth_db}
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}
      GITHUB_REDIRECT_URI: ${GITHUB_REDIRECT_URI}
      JWT_SECRET: ${JWT_SECRET}
      NODE_ENV: ${NODE_ENV:-production}
    depends_on:
      auth-postgres:
        condition: service_healthy
    command: sh -c "npx prisma migrate deploy && node dist/main.js"
    networks:
      - codepilot-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # User Service
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: user-service
    restart: unless-stopped
    ports:
      - "${USER_SERVICE_PORT:-4002}:4002"
    environment:
      PORT: 4002
      DATABASE_URL: postgresql://${USER_POSTGRES_USER:-userservice}:${USER_POSTGRES_PASSWORD:-userservice_password}@user-postgres:5432/${USER_POSTGRES_DB:-userservice_db}
      JWT_SECRET: ${JWT_SECRET}
      NODE_ENV: ${NODE_ENV:-production}
    depends_on:
      user-postgres:
        condition: service_healthy
    volumes:
      - ./services/user-service/prisma:/app/prisma
    command: sh -c "npx prisma migrate deploy && node dist/main.js"
    networks:
      - codepilot-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Code Analysis Service
  analysis-service:
    build:
      context: ./services/code-analysis-service
      dockerfile: Dockerfile
    container_name: analysis-service
    restart: unless-stopped
    ports:
      - "${ANALYSIS_SERVICE_PORT:-5003}:5003"
    environment:
      PORT: 5003
      NODE_ENV: ${NODE_ENV:-production}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      PINECONE_API_KEY: ${PINECONE_API_KEY}
      PINECONE_INDEX: ${PINECONE_INDEX:-code-analysis}
      COHERE_API_KEY: ${COHERE_API_KEY}
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-neo4j_password}
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - codepilot-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Failure Prediction Service
  prediction-service:
    build:
      context: ./services/failure-prediction-service
      dockerfile: Dockerfile
    container_name: prediction-service
    restart: unless-stopped
    ports:
      - "${PREDICTION_SERVICE_PORT:-5000}:5000"
    environment:
      PORT: 5000
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_URL: postgresql://${PREDICTION_POSTGRES_USER:-predictionservice}:${PREDICTION_POSTGRES_PASSWORD:-prediction_password}@prediction-postgres:5432/${PREDICTION_POSTGRES_DB:-prediction_db}
      PYTHON_PATH: ${PYTHON_PATH:-/usr/local/bin/python}
      MODEL_DIR: ${MODEL_DIR:-/app/src/model}
    depends_on:
      prediction-postgres:
        condition: service_healthy
    volumes:
      - ./services/failure-prediction-service/prisma:/app/prisma
      - ./services/failure-prediction-service/src/model:/app/src/model
    command: sh -c "npx prisma migrate deploy && node dist/main.js"
    networks:
      - codepilot-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Review Comment Service
  review-service:
    build:
      context: ./services/review-comment-service
      dockerfile: Dockerfile
    container_name: review-service
    restart: unless-stopped
    ports:
      - "${REVIEW_SERVICE_PORT:-6000}:6000"
    environment:
      PORT: 6000
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      NODE_ENV: ${NODE_ENV:-production}
    networks:
      - codepilot-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Orchestrator Service
  orchestrator-service:
    build:
      context: ./services/orchestrator-service
      dockerfile: Dockerfile
    container_name: orchestrator-service
    restart: unless-stopped
    ports:
      - "${ORCHESTRATOR_SERVICE_PORT:-7000}:7000"
    environment:
      PORT: 7000
      NODE_ENV: ${NODE_ENV:-production}
      ANALYSIS_SERVICE_URL: http://analysis-service:5003
      PREDICTION_SERVICE_URL: http://prediction-service:5000
      REVIEW_SERVICE_URL: http://review-service:6000
    depends_on:
      - analysis-service
      - prediction-service
      - review-service
    networks:
      - codepilot-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Queue Service
  queue-service:
    build:
      context: ./services/queue-service
      dockerfile: Dockerfile
    container_name: queue-service
    restart: unless-stopped
    ports:
      - "${QUEUE_SERVICE_PORT:-3000}:3000"
    environment:
      PORT: 3000
      NODE_ENV: ${NODE_ENV:-production}
      BASE_URL: ${BASE_URL:-http://queue-service:3000}
      QSTASH_URL: ${QSTASH_URL}
      QSTASH_TOKEN: ${QSTASH_TOKEN}
      QSTASH_CURRENT_SIGNING_KEY: ${QSTASH_CURRENT_SIGNING_KEY}
      QSTASH_NEXT_SIGNING_KEY: ${QSTASH_NEXT_SIGNING_KEY}
      AUTH_SERVICE_URL: http://auth-service:4001
      CODE_ANALYSIS_SERVICE_URL: http://analysis-service:5003
      REVIEW_SERVICE_URL: http://review-service:6000
      FAILURE_PREDICTION_SERVICE_URL: http://prediction-service:5000
      MAX_RETRIES: ${MAX_RETRIES:-3}
      RETRY_DELAY: ${RETRY_DELAY:-2000}
      GITHUB_WEBHOOK_SECRET: ${GITHUB_WEBHOOK_SECRET}
    depends_on:
      - auth-service
      - analysis-service
      - review-service
      - prediction-service
    networks:
      - codepilot-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # API Gateway
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: gateway
    restart: unless-stopped
    ports:
      - "${GATEWAY_PORT:-4000}:4000"
    environment:
      PORT: 4000
      NODE_ENV: ${NODE_ENV:-production}
      AUTH_SERVICE_URL: http://auth-service:4001
      USER_SERVICE_URL: http://user-service:4002
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      - auth-service
      - user-service
    networks:
      - codepilot-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Client (Frontend)
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: client
    restart: unless-stopped
    ports:
      - "${CLIENT_PORT:-80}:80"
    depends_on:
      - gateway
    networks:
      - codepilot-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  codepilot-network:
    driver: bridge

volumes:
  auth_postgres_data:
  user_postgres_data:
  prediction_postgres_data:
  neo4j_data:
  neo4j_logs:

