datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model UserProfile {
  id              Int           @id @default(autoincrement())
  userId          String        @unique

  // Basic profile
  name            String?
  email           String?
  githubUsername  String?
  avatarUrl       String?

  // Settings
  theme           String?       @default("light")

  // API & Integrations
  claudeApiKey    String?
  githubToken     String?
  modelEndpoint   String?

  // Prediction / AI Settings
  riskThreshold       Float?    @default(0.5)
  enableLlmReview     Boolean   @default(true)
  enableMlPrediction  Boolean   @default(true)

  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  repositories    Repository[]
}

model Repository {
  id              Int           @id @default(autoincrement())
  name            String
  lastAnalyzed    DateTime?
  failureRate     Float?
  userProfileId   Int
  userProfile     UserProfile   @relation(fields: [userProfileId], references: [id])
  pullRequests    PullRequest[]

  @@unique([name, userProfileId])
}

model PullRequest {
  id              Int       @id @default(autoincrement())
  number          Int       // GitHub PR number (e.g., 2 for PR #2)
  title           String
  author          String
  status          String
  createdAt       DateTime  @default(now())
  repositoryId    Int
  repository      Repository @relation(fields: [repositoryId], references: [id])
  repoName        String?
  
  analysisSummary     String?
  riskScore           Float?
  llmReview           String?
  lastAnalyzed        DateTime?

  analysisDuration    Float?     
  predictedFailure    Boolean?   
  actualFailure       Boolean?  

  rating           Float? 
  ratingHistory    RatingHistory[]
  changedFiles     ChangedFile[] 
  reviewComments   ReviewComment[]

  // Unique constraint ensures each PR number is unique within a repository
  @@unique([number, repositoryId])
  @@index([repositoryId])
}

model RatingHistory {
  id            Int       @id @default(autoincrement())
  pullRequestId Int
  rating        Int       
  createdAt     DateTime  @default(now())
  pullRequest   PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  
  @@index([pullRequestId])
}

model ChangedFile {
  id             Int         @id @default(autoincrement())
  filename       String
  additions      Int
  deletions      Int
  complexity     Float?
  diff           String?
  pullRequestId  Int
  pullRequest    PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  
  @@index([pullRequestId])
}

model ReviewComment {
  id             Int         @id @default(autoincrement())
  file           String
  line           Int
  comment        String
  pullRequestId  Int
  pullRequest    PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  
  @@index([pullRequestId])
}
